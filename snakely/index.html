<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Snakely</title>

<style>
/* =========================================================
   THEME & TOKENS
   ======================================================= */
:root{
  --bg1:#a8edea; --bg2:#fed6e3;
  --ink:#0f172a;
  --glass-bg: rgba(255,255,255,.22);
  --glass-brd: rgba(255,255,255,.38);
  --chip: rgba(255,255,255,.7);

  --noun:#3b82f6; --verb:#ef4444; --adj:#8b5cf6;
  --btn-5050-start:#f59e0b; --btn-5050-end:#fbbf24;
  --btn-next-start:#10b981; --btn-next-end:#34d399;
  --btn-flip-start:#6366f1; --btn-flip-end:#818cf8;
  --btn-pass-start:#ef4444; --btn-pass-end:#f87171;

  --accent:#22c55e;

  --z-base: 0;
  --z-tabs: 200;
  --z-title: 220;
  --z-logo: 300;
  --z-theme-btn: 350;
  --z-reselect: 360;
  --z-chest-btn: 1000;
  --z-drawer: 1100;
  --z-modal-backdrop: 2000;
  --z-modal: 2001;

  /* Level colors */
  --A1-grad: linear-gradient(135deg,#00c6ff,#0072ff);
  --A2-grad: linear-gradient(135deg,#84fab0,#8fd3f4);
  --B1-grad: linear-gradient(135deg,#f6d365,#fda085);
  --B2-grad: linear-gradient(135deg,#a18cd1,#fbc2eb);
  --C1-grad: linear-gradient(135deg,#f5576c,#f093fb);

  --A1-solid:#1f6fff;
  --A2-solid:#19c28f;
  --B1-solid:#f59e0b;
  --B2-solid:#8b5cf6;
  --C1-solid:#ef4444;

  /* Navbar & Tabs ölçümü için */
  --navH: 68px;     /* JS ile güncellenecek */
  --tabsH: 56px;    /* JS ile güncellenecek */
}
body[data-theme="dark"]{
  --bg1:#0f172a; --bg2:#1f2937;
  --ink:#e5e7eb;
  --glass-bg: rgba(17,24,39,.35);
  --glass-brd: rgba(255,255,255,.18);
  --chip: rgba(17,24,39,.55);
}

/* =========================================================
   LAYOUT
   ======================================================= */
html{ -webkit-text-size-adjust:100%; scrollbar-gutter:stable both-edges; }
html, body { overscroll-behavior:none; height:100svh; }
body{
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;
  min-height:100svh; margin:0; z-index: var(--z-logo);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:18px; padding:24px; box-sizing:border-box; color:var(--ink);
}
body.has-reselect{ padding-bottom: 76px; }

/* --- STAGE LOCK: başlangıçta sadece seviye seçimi görünsün --- */
body.stage-select .tabs,
body.stage-select #free-wrap,
body.stage-select #test-wrap,
body.stage-select .drawer-btn { display:none !important; }
body.stage-select #levelSelect{ display:flex !important; }

.logo{
  position:fixed; left:12px; top:12px; z-index: var(--z-logo);
  width:72px; height:72px; object-fit:cover; border-radius:50%; padding:8px;
  background: radial-gradient(120px 120px at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.65));
  border:2px solid rgba(0,0,0,.08);
  box-shadow: 0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.65);
}
body[data-theme="dark"] .logo{
  background: radial-gradient(120px 120px at 30% 30%, rgba(255,255,255,.15), rgba(255,255,255,.06));
  border:2px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 24px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.12);
}

.title{
  position:fixed; top:18px; left:50%; transform:translateX(-50%);
  font-size:32px; font-weight:900;
  background:linear-gradient(90deg, #d8d3ce, #cfafbb, #b0d0ec);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 2px 8px rgba(0,0,0,0.25); letter-spacing:1px;
  z-index: var(--z-title); animation:fadeSlideIn 1s ease-out forwards;
}
@keyframes fadeSlideIn { from{opacity:0; transform:translate(-50%,-10px)} to{opacity:1; transform:translate(-50%,0)} }

/* ==== TABS (mobilde üstte, sticky) ==== */
.tabs{
  position:relative; display:none; gap:10px; padding:6px;
  border-radius:14px; backdrop-filter:blur(8px);
  background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.35); overflow:hidden;
}
.tab-indicator{
  position:absolute; z-index:1; left:0; top:0; width:0; height:0;
  background:rgba(0,0,0,.18); border-radius:12px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.35);
  transition:left .25s ease, top .25s ease, width .25s ease, height .25s ease, border-radius .25s ease;
}
.tab{ position:relative; z-index:2; padding:10px 16px; font-weight:800; font-size:14px; color:#ffffffee; cursor:pointer; border-radius:10px; transition:opacity .2s ease; user-select:none; }
.tab.active{ opacity:1 } .tab:not(.active){ opacity:.85 }

.wrap{ display:flex; flex-direction:column; align-items:center; gap:14px; }

/* =========================================================
   FREE MODE CARD
   ======================================================= */
.card{
  width:min(92vw,360px); aspect-ratio:3/2; perspective:1200px; -webkit-perspective:1200px;
  touch-action: pan-y; transform: translateZ(0); will-change: transform;
  margin-top: 5px;
}
.card-inner{
  position:relative; width:100%; height:100%;
  transform-style:preserve-3d; -webkit-transform-style:preserve-3d;
  border-radius:20px; transition:transform .8s cubic-bezier(.4,.2,.2,1), box-shadow .2s ease;
}
.card-inner.flipped{ transform:rotateY(180deg) translateZ(0); }

.face{
  position:absolute; inset:0; border-radius:20px; display:grid; grid-template-rows:42px 1fr;
  box-shadow:0 18px 40px rgba(0,0,0,.25); overflow:hidden; background-size:220% 220%;
  animation:gradientShift 6s ease infinite; color:#fff;
  -webkit-backface-visibility:hidden; backface-visibility:hidden;
  transform: translateZ(0.1px) rotate(0.02deg); will-change: transform;
  -webkit-font-smoothing: antialiased;
}
.card-inner.animating .face{ animation-play-state: paused !important; }
.card-inner.animating .face::after{ animation-play-state: paused !important; opacity: 1 !important; }

.back{ transform:rotateY(180deg); }
.front, .back{ -webkit-backface-visibility: hidden; backface-visibility: hidden; }
.card-inner:not(.flipped) .front { transform:translateZ(1px); }
.card-inner.flipped .back { transform:rotateY(180deg) translateZ(1px); }

.card-meta{ position:relative; padding:12px 14px; height:42px; }
.card-meta .badge{
  display:inline-block; max-width: calc(100% - 34px - 12px);
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  font-size:12px; font-weight:700; letter-spacing:.5px; text-transform:uppercase;
  padding:6px 10px; border-radius:999px; color:#fff; border:1px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.18); backdrop-filter:blur(8px);
  box-shadow:0 6px 14px rgba(0,0,0,.15) inset;
}
.card-meta .avatar{
  position:absolute; right:14px; top:50%; transform:translateY(-50%);
  width:34px; height:34px; display:grid; place-items:center; border-radius:50%;
  background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.35); backdrop-filter:blur(8px);
  box-shadow:0 6px 14px rgba(0,0,0,.15) inset; user-select:none;
}

.word{
  display:grid; place-items:center; padding:0 16px;
  font-weight:800; font-size:clamp(22px, 6vw, 32px); text-align:center; text-shadow:0 2px 10px rgba(0,0,0,.25);
  position:relative; line-height:1.15; word-break: break-word; overflow-wrap: anywhere;
}
.face::after{ content:""; position:absolute; top:0; left:-60%; width:45%; height:100%;
  background:linear-gradient(120deg,rgba(255,255,255,.35) 0%,rgba(255,255,255,0) 70%);
  transform:skewX(-25deg); animation:shine 3s infinite;
}

.buttons{ display:flex; gap:18px; flex-wrap:wrap; justify-content:center; }
button{
  position:relative; padding:14px 20px; border:none; border-radius:14px;
  font-size:15px; font-weight:800; color:#fff; cursor:pointer;
  box-shadow:0 10px 22px rgba(0,0,0,.20); transition:transform .2s ease, box-shadow .2s ease;
  overflow:hidden; min-height:44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;
}
button::after{ content:""; position:absolute; inset:0; left:-100%;
  background:linear-gradient(90deg,rgba(255,255,255,.0),rgba(255,255,255,.25),rgba(255,255,255,0));
  transition:left .45s ease;
}
button:hover::after{ left:100%; }
button:active{ transform:scale(.96); box-shadow:0 6px 14px rgba(0,0,0,.18); }
.btn-flip{ background:linear-gradient(45deg,var(--btn-flip-start),var(--btn-flip-end)); }
.btn-pass{ background:linear-gradient(45deg,var(--btn-pass-start),var(--btn-pass-end)); }
.btn-next{ background:linear-gradient(45deg,var(--btn-next-start),var(--btn-next-end)); }
.btn-5050{ background:linear-gradient(45deg,var(--btn-5050-start),var(--btn-5050-end)); color:#1f2937; }

/* =========================================================
   PANEL / QUIZ
   ======================================================= */
.panel{
  width:min(820px,94vw);
  background:var(--glass-bg); border:1px solid var(--glass-brd);
  border-radius:18px; padding:18px;
  backdrop-filter: blur(14px) saturate(120%);
  box-shadow:0 24px 60px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.25);
  margin-top: 5px;
}
.panel-head{ display:flex; align-items:center; gap:12px; padding:6px 8px 12px; border-bottom:1px solid rgba(255,255,255,.28); margin-bottom:12px; }
.panel-badge{ font-weight:900; font-size:12px; color:#fff; padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#6366f1,#22c55e); box-shadow:0 6px 16px rgba(0,0,0,.15); }
.panel-title{ font-weight:900; letter-spacing:.4px; color:#fffdfcdd; text-shadow:0 1px 8px rgba(0,0,0,.18); }

.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; } .grow{ flex:1; }
.stat{ font-size:13px; color:var(--ink); font-weight:800; background:var(--chip); padding:6px 10px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.12); }

.progress{ height:10px; width:100%; background:rgba(255,255,255,.45); border-radius:999px; overflow:hidden; border:1px solid rgba(0,0,0,.06); }
.bar{ height:100%; width:0%; background: linear-gradient(90deg,#22c55e,#84cc16,#a3e635); background-size:200% 100%; animation: progressStripe 1.2s linear infinite; }
@keyframes progressStripe{ 0%{ background-position:0% 50% } 100%{ background-position:200% 50% } }

#qtext{
  font-size:22px; font-weight:900; text-align:center;
  margin:16px 0 8px 0;
  background:linear-gradient(90deg, #4facfe, #00f2fe, #43e97b);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 2px 8px rgba(0,0,0,0.18);
  letter-spacing:.6px; animation:fadePop .6s ease;
}
body[data-theme="light"] #qtext{ background:none !important; -webkit-text-fill-color:initial; color:#413c3c !important; text-shadow:none; }
@keyframes fadePop { 0%{opacity:0; transform:scale(.96)} 100%{opacity:1; transform:scale(1)} }

.choices{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
.choice{
  position:relative; padding:16px; border-radius:14px; background:rgba(255,255,255,.9); border:1px solid rgba(0,0,0,.06);
  cursor:pointer; text-align:center; font-weight:900; color:#0f172a;
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  box-shadow:0 8px 18px rgba(0,0,0,.08);
}
body[data-theme="dark"] .choice{ background:rgba(31,41,55,.8); color:#f8fafc; }
.choice:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
.choice.correct{ border-color:#22c55e; box-shadow:0 12px 26px rgba(34,197,94,.25); }
.choice.wrong{ border-color:#ef4444; box-shadow:0 12px 26px rgba(239,68,68,.25); }

.answer-row{ display:flex; gap:10px; margin-top:12px; }
.input{
  flex:1; padding:14px 16px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
  font-size:16px; outline:none; background:rgba(255,255,255,.95);
  box-shadow:inset 0 2px 6px rgba(0,0,0,.04), 0 6px 16px rgba(0,0,0,.06);
  transition:border-color .15s ease, box-shadow .15s ease;
}
body[data-theme="dark"] .input{ background:rgba(17,24,39,.85); color:#e5e7eb; border-color:rgba(255,255,255,.12); }
.input:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25), inset 0 2px 6px rgba(0,0,0,.05); }

.actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }

/* =========================================================
   DRAWER
   ======================================================= */
.drawer-btn{
  position:fixed; top:14px; right:14px; z-index: var(--z-chest-btn);
  padding:8px; border:none; border-radius:12px; cursor:pointer;
  background:linear-gradient(45deg,#0ea5e9,#38bdf8);
  box-shadow:0 10px 22px rgba(0,0,0,.20);
  display:none; align-items:center; justify-content:center;
  min-height:44px;
}
.chest-icon{ width:48px; height:auto; display:block; }
.drawer{
  position:fixed; top:72px; right:14px; z-index: var(--z-drawer);
  max-width:min(380px,90vw); min-width:260px;
  background:rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:14px;
  padding:12px; box-shadow:0 18px 40px rgba(0,0,0,.25); display:none;
  color:#0f172a; font-size:14px;
}
body[data-theme="dark"] .drawer{ background:rgba(17,24,39,.96); color:#e5e7eb; border-color:rgba(255,255,255,.12); }

.theme-toggle{
  position:fixed; top:14px; right:74px; z-index: var(--z-theme-btn);
  padding:10px 12px; border:none; border-radius:12px; cursor:pointer;
  font-weight:800; font-size:14px; color:#fff;
  background:linear-gradient(45deg,#6b7280,#111827);
  box-shadow:0 10px 22px rgba(0,0,0,.20);
}

/* =========================================================
   MEDIA / ACCESSIBILITY / ANIMS
   ======================================================= */
@media (max-width: 600px){
  body{ padding:16px; gap:14px; justify-content: flex-start;}
  /* Mobil üst tabs: navbar altına yapışkan */
  body:not(.stage-select) .tabs{
    width:100%;
    display:flex !important;
    flex-direction:row;
    gap:8px;
    border-radius:14px;
    position: sticky;
    top: calc(var(--navH, 68px) + env(safe-area-inset-top) + 8px);
    z-index: var(--z-tabs);
    margin-top: 8px;
    min-height: 40px;
  }
  .tab{ flex:1; text-align:center; }

  /* Tabs’in altında içerik güvenli boşluk */
  .wrap, #test-wrap{ margin-top: calc(var(--tabsH, 56px) + 16px); }

  .row{ flex-direction:column; align-items:stretch; }
  .stat{ width:100%; text-align:center; }
  .progress{ height:12px; }
  .choices{ grid-template-columns:1fr; }
  .tools-row > button{ width:100%; max-width:320px; margin:0 auto; }
  .actions{ flex-direction:column; align-items:center; }
  .actions > button{ width:100%; max-width:320px; }
  .panel{ padding:14px; }
  .theme-toggle{ right:70px; }
  .chest-icon{ width:46px; }
}

/* feedback */
.fx-correct{ outline:2px solid #22c55e !important; }
.fx-wrong{ outline:2px solid #ef4444 !important; }
.flash-correct{ animation: flashOK .55s ease; }
@keyframes flashOK{ 0%{box-shadow:0 0 0 rgba(34,197,94,0)} 30%{box-shadow:0 0 0 6px rgba(34,197,94,.25)} 100%{box-shadow:0 0 0 rgba(34,197,94,0)} }
.shake-wrong{ animation: shake .35s ease; }
@keyframes shake{ 10%{transform:translateX(-3px)} 30%{transform:translateX(3px)} 50%{transform:translateX(-2px)} 70%{transform:translateX(2px)} 90%{transform:translateX(-1px)} 100%{transform:translateX(0)} }

.pass-left{ animation: passLeft .35s cubic-bezier(.4,.2,.2,1) both; }
@keyframes passLeft{ from{transform:translate3d(0,0,0)} to{transform:translate3d(-40px,0,0)} }
.enter-right{ animation: enterRight .35s cubic-bezier(.4,.2,.2,1) both; }
@keyframes enterRight{ from{transform:translate3d(40px,0,0)} to{transform:translate3d(0,0,0)} }

/* Level rings */
.levels-wrapper{ display:flex; flex-direction:column; gap:10px; align-items:flex-start; margin-bottom:10px; }
.level-item{ display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 8px; border-radius:10px; transition: background .18s ease; }
.level-item:hover{ background:rgba(0,0,0,.05); }
body[data-theme="dark"] .level-item:hover{ background:rgba(255,255,255,.06); }
.level-ring{ width:44px; height:44px; border-radius:50%; position:relative; background:conic-gradient(var(--accent) var(--deg,0deg), rgba(0,0,0,.12) 0deg); box-shadow:inset 0 0 0 2px rgba(0,0,0,.06); display:grid; place-items:center; }
body[data-theme="dark"] .level-ring{ background:conic-gradient(var(--accent) var(--deg,0deg), rgba(255,255,255,.12) 0deg); box-shadow:inset 0 0 0 2px rgba(255,255,255,.08); }
.level-ring::after{ content:""; position:absolute; inset:4px; border-radius:50%; background:rgba(255,255,255,.92); }
body[data-theme="dark"] .level-ring::after{ background:rgba(17,24,39,.9); }
.ring-text{ position:relative; font-weight:900; font-size:12px; }
.level-meta{ display:flex; flex-direction:column; line-height:1.15; font-size:12.5px; color:var(--ink); }
.level-acc{ font-weight:800; } .level-seen{ opacity:.9; }

@keyframes gradientShift{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes shine{ 0%{left:-60%} 55%{left:130%} 100%{left:130%} }

.card-inner[data-type="noun"]{ box-shadow:0 18px 40px rgba(0,0,0,.25), 0 0 0 2px var(--noun) inset; }
.card-inner[data-type="verb"]{ box-shadow:0 18px 40px rgba(0,0,0,.25), 0 0 0 2px var(--verb) inset; }
.card-inner[data-type="adjective"]{ box-shadow:0 18px 40px rgba(0,0,0,.25), 0 0 0 2px var(--adj) inset; }

@media (prefers-reduced-motion: reduce){
  .card-inner{ transition:none !important; }
  .face::after, .bar, .enter-right, .pass-left{ animation:none !important; }
}

/* ===== TOAST ===== */
.toast-container{
  position: fixed;
  top: calc(12px + env(safe-area-inset-top));
  left: 0; right: 0;
  margin: 0 auto;
  width: min(520px, 94vw);
  z-index: 5000;
  display: grid; gap: 8px; pointer-events: none;
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}
.toast{
  box-sizing: border-box;
  pointer-events: auto;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 800;
  font-size: 14px;
  box-shadow: 0 12px 26px rgba(0,0,0,.22);
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.96);
  color: #0f172a;
  animation: toastIn .24s ease both;
  max-width: 100%;
  overflow: hidden;
  margin-inline: 8px;
}
body[data-theme="dark"] .toast{ background: rgba(17,24,39,.96); border-color: rgba(255,255,255,.12); color: #e5e7eb; }
.toast.success{ border-left: 6px solid #22c55e; }
.toast.warning{ border-left: 6px solid #f59e0b; }
.toast.error{   border-left: 6px solid #ef4444; }
.toast .close{ background: transparent; border: none; cursor: pointer; font-weight: 900; font-size: 16px; line-height: 1; color: inherit; opacity: .8; }
.toast .row{ display: flex; align-items: center; justify-content: space-between; gap: 10px; min-width: 0; }
.toast .row > div:first-child{ flex: 1 1 auto; min-width: 0; word-break: break-word; overflow-wrap: anywhere; hyphens: auto; }
@keyframes toastIn{ from{ opacity:0; transform: translateY(-6px); } to{ opacity:1; transform: translateY(0); } }
@keyframes toastOut{ to{ opacity:0; transform: translateY(-6px); } }

/* ===== LEVEL SELECT ===== */
.level-select-wrap{
  display:flex; flex-direction:column; align-items:center; gap:16px;
  width:100%;
  margin-top: 84px;
  animation: fadeInUp .35s ease both;
}
@keyframes fadeInUp { from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0);} }

.level-badge{
  font-weight:1000; font-size:12px; letter-spacing:.8px; text-transform:uppercase;
  color:#0f172a; padding:8px 12px; border-radius:999px;
  background: linear-gradient(90deg,#34d399,#22d3ee);
  box-shadow:0 8px 18px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.35);
}

.level-grid{
  display:grid;
  grid-template-columns: repeat(5, minmax(160px, 1fr));
  gap:14px;
  width:min(1100px, 96vw);
}
@media (max-width: 900px){
  .level-grid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
}
@media (max-width: 620px){
  .level-grid{ grid-template-columns: repeat(1, minmax(220px, 1fr)); gap:12px; }
}
.level-card{
  position:relative; border-radius:16px; padding:16px; min-height:120px; border:1px solid var(--glass-brd);
  box-shadow:0 16px 38px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.25);
  color:#fff; display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:flex-start;
  cursor:pointer; overflow:hidden; backdrop-filter: blur(10px) saturate(120%);
  transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease, background .14s ease, opacity .35s ease, filter .35s ease;
}
.level-card:hover{ transform: translateY(-2px); box-shadow:0 22px 48px rgba(0,0,0,.22); }
.level-card.A1{ background: var(--A1-grad); }
.level-card.A2{ background: var(--A2-grad); }
.level-card.B1{ background: var(--B1-grad); }
.level-card.B2{ background: var(--B2-grad); }
.level-card.C1{ background: var(--C1-grad); }

.level-name{ font-size:28px; font-weight:1000; letter-spacing:.8px; }
.level-count{ font-size:13px; font-weight:800; color:#0f172a; background:var(--chip); padding:6px 10px; border-radius:999px; }
.level-card .level-count{ background: rgba(255,255,255,.88) !important; color:#0f172a !important; }
body[data-theme="dark"] .level-card .level-count{ background: rgba(255,255,255,.92) !important; color:#0f172a !important; }

/* level fade */
.level-card.fade-away{ opacity: 0; transform: translateY(8px) scale(.98); filter: blur(2px); }

/* Reselect button */
.reselect-btn{
  position: fixed;
  bottom: calc(12px + env(safe-area-inset-bottom));
  left: calc(12px + env(safe-area-inset-left));
  z-index: var(--z-reselect);
  padding: 10px 12px; border-radius: 12px; border: none;
  background: linear-gradient(45deg, #ef4444, #f89171);
  color: #fff; font-weight: 900; font-size: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,.22); cursor: pointer; display: none;
}
.reselect-btn:hover{ filter: brightness(1.05); }
.reselect-btn:active{ transform: translateY(1px); }
@media (max-width:600px){
  .reselect-btn{
    left: 12px; right: 12px; width: auto;
    background: linear-gradient(45deg, #ef4444, #f89171);
    font-size: 15px; border-radius:14px; padding:12px 18px;
  }
}

/* ===== MODAL ===== */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index: var(--z-modal-backdrop); }
.modal{
  width:min(680px,94vw); max-height:min(78vh, 860px); overflow:auto;
  background:var(--glass-bg); border:1px solid var(--glass-brd);
  backdrop-filter: blur(14px) saturate(120%);
  border-radius:16px; padding:14px;
  box-shadow:0 24px 60px rgba(0,0,0,.35);
  color:var(--ink); z-index: var(--z-modal);
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,.08); }
body[data-theme="dark"] .modal-head{ border-bottom-color: rgba(255,255,255,.12); }
.modal-title{ font-weight:900; }
.modal-close{ border:none; background:linear-gradient(45deg,#ef4444,#f87171); color:#fff; font-weight:800; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.18); }
.words-table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
.words-table th, .words-table td{ padding:8px 10px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left; }
.words-table th{ font-weight:900; }
body[data-theme="dark"] .words-table th, body[data-theme="dark"] .words-table td{ border-bottom-color: rgba(255,255,255,.12); }

.current-level {
  margin-top: 6px; font-weight: 800; font-size: 14px; padding: 6px 12px;
  border-radius: 999px; background: linear-gradient(45deg,#10b981,#3b82f6);
  color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,.15); text-align: center; display: inline-block;
}
@media (max-width:600px){
  .current-level { font-size:13px; padding:5px 10px; }
}

@keyframes fadeOutSmooth { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.97); } }
.fade-out { animation: fadeOutSmooth .6s ease forwards; }

/* ===== NAVBAR ===== */
:root{ --z-navbar: 260; }
.navbar{
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: var(--z-navbar);
  backdrop-filter: blur(14px) saturate(120%);
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-brd);
  box-shadow: 0 10px 28px rgba(0,0,0,.18);
}
body{ padding-top: 68px; }

.nav-inner{
  max-width: 1100px; margin: 0 auto; padding: 10px 14px;
  display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;
}
.brand{ display:flex; align-items:center; gap:10px; text-decoration:none; }
.brand-logo{ width:38px; height:38px; border-radius:50%; object-fit:cover; }
.brand-text{ font-weight:1000; letter-spacing:.4px; font-size:18px; color: var(--ink); }
.brand-beta{ font-size:11px; font-weight:900; color:#fff; padding:3px 8px; border-radius:999px;
  background: linear-gradient(45deg,#06b6d4,#22c55e); box-shadow:0 6px 16px rgba(0,0,0,.15);
}

.nav-links{ display:flex; gap:8px; align-items:center; justify-content:center; }
.nav-link{
  font-weight:900; font-size:14px; padding:8px 12px; border-radius:10px; border:1px solid transparent;
  background: transparent; color: var(--ink); cursor: pointer;
}
.nav-link:hover{ background: rgba(255,255,255,.35); border-color: var(--glass-brd); }
.nav-link.active{ background: rgba(255,255,255,.55); border-color: var(--glass-brd); box-shadow: 0 10px 22px rgba(0,0,0,.08); }

.nav-dropdown{ position:relative; }
.nav-dd-btn{ display:flex; align-items:center; gap:8px; }
.nav-pill{
  font-size:11px; font-weight:900; color:#0f172a; background:rgba(255,255,255,.88);
  padding:3px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.06);
}
body[data-theme="dark"] .nav-pill{ color:#0f172a; }

.nav-dd{
  position:absolute; top: calc(100% + 6px); left: 0; min-width: 180px;
  background: rgba(255,255,255,.96); color:#0f172a; border:1px solid rgba(0,0,0,.08); border-radius:12px;
  box-shadow: 0 18px 40px rgba(0,0,0,.25); padding:8px; display:none;
}
body[data-theme="dark"] .nav-dd{ background: rgba(17,24,39,.96); color:#e5e7eb; border-color: rgba(255,255,255,.12); }
.nav-dd-item{
  width:100%; text-align:left; padding:10px 10px; border-radius:10px; border:none; background:transparent; color:inherit; cursor:pointer; font-weight:900;
}
.nav-dd-item:hover{ background: rgba(0,0,0,.06); }
body[data-theme="dark"] .nav-dd-item:hover{ background: rgba(255,255,255,.08); }

.nav-cta{ display:flex; align-items:center; gap:10px; }
.icon-btn{
  padding:8px 10px; border-radius:10px; border:none; cursor:pointer; font-size:16px; font-weight:900; color:#fff;
  background: linear-gradient(45deg,#6b7280,#111827); box-shadow:0 10px 22px rgba(0,0,0,.2);
}
.icon-chest{
  display:inline-flex; align-items:center; justify-content:center;
  width:44px; height:44px; border-radius:12px;
  border:1px solid var(--glass-brd);
  background: rgba(255,255,255,.25);
  box-shadow: 0 10px 22px rgba(0,0,0,.12);
  cursor:pointer;
}
body[data-theme="dark"] .icon-chest{ background: rgba(31,41,55,.55); }
.icon-chest img{ width:28px; height:auto; display:block; }

.pill-btn{
  padding:8px 12px; border-radius:999px; border:none; cursor:pointer; font-weight:900; color:#fff;
  background: linear-gradient(45deg,#10b981,#34d399); box-shadow:0 10px 22px rgba(0,0,0,.2);
}

.burger{
  display:none; width:40px; height:40px; border-radius:10px; border:1px solid var(--glass-brd);
  background:rgba(255,255,255,.25); box-shadow:0 10px 22px rgba(0,0,0,.12);
  align-items:center; justify-content:center; gap:4px; flex-direction:column; cursor:pointer;
}
.burger span{ display:block; width:20px; height:2px; background: var(--ink); border-radius:2px; }

.nav-drawer{
  display:none; padding:12px; border-top:1px solid var(--glass-brd);
  background: var(--glass-bg); backdrop-filter: blur(14px) saturate(120%);
}
.drawer-item{
  width:100%; text-align:left; padding:12px; border-radius:12px; border:1px solid var(--glass-brd);
  background: rgba(255,255,255,.75); color:#0f172a; font-weight:900; margin-bottom:8px; cursor:pointer;
}
body[data-theme="dark"] .drawer-item{ background: rgba(17,24,39,.85); color:#e5e7eb; }
.drawer-sep{ height:1px; background: var(--glass-brd); margin:8px 0; }
.drawer-group-title{ font-weight:1000; font-size:12px; opacity:.9; margin-bottom:6px; }
.drawer-levels{ display:flex; flex-wrap:wrap; gap:8px; }
.lvl-chip{
  border:none; cursor:pointer; padding:8px 10px; border-radius:999px; font-weight:900;
  background: rgba(255,255,255,.88); color:#0f172a; border:1px solid rgba(0,0,0,.06);
}
.drawer-actions{ display:flex; gap:8px; margin-top:10px; }

@media (max-width: 900px){
  .nav-inner{ grid-template-columns: auto auto 1fr; }
  .nav-links{ display:none; }
  .burger{ display:flex; margin-left:auto; }
  .nav-cta .pill-btn{ display:none; }
}
@media (max-width: 600px){
  body{ padding-top: 0; } /* navbar fixed; üst boşluk body'den kaldırıldı */
}

@media (max-width: 900px){
  .nav-inner{ grid-template-columns: auto 1fr auto; }
}

/* Eski üst öğeleri gizle (yeni navbar ile çakışmasın) */
/* .tabs artık MOBİLDE GÖRÜNECEK, bu yüzden listeden çıkardık */
.logo, .title, .theme-toggle, .drawer-btn, .reselect-btn{ display:none !important; }
</style>
</head>

<body data-theme="light" class="stage-select">

  <img src="../assets/images/Maskot.png" alt="Snakely" class="logo" loading="lazy" decoding="async"/>
  <div class="title">Snakely</div>

  <!-- LEVEL SELECT -->
  <div id="levelSelect" class="level-select-wrap" aria-live="polite">
    <div class="level-badge level-title">Seviye Seç</div>
    <div id="levelGrid" class="level-grid" role="list"></div>
  </div>

  <!-- Mobil üst tabs (modlar arası gezinim) -->
  <div class="tabs" id="tabs" role="tablist" aria-label="Mod Seç">
    <span class="tab-indicator" id="tabIndicator"></span>
    <div id="tab-free" class="tab active" role="tab" aria-selected="true" tabindex="0">Serbest Gezinim</div>
    <div id="tab-test" class="tab" role="tab" aria-selected="false" tabindex="0">Kelime Öğrenimi</div>
  </div>

  <button id="themeToggle" class="theme-toggle" aria-label="Tema Değiştir">🌙</button>

  <!-- NAVBAR -->
<header class="navbar" role="banner">
  <div class="nav-inner">
    <a class="brand" href="#" aria-label="Snakely Ana Sayfa">
      <img src="../assets/images/Maskot.png" alt="" class="brand-logo" decoding="async" loading="lazy">
      <span class="brand-text">Snakely</span>
      <span class="brand-beta">beta</span>
    </a>

    <nav class="nav-links" role="navigation" aria-label="Ana menü">
      <button id="nav-free" class="nav-link" type="button">Serbest Gezinim</button>
      <button id="nav-test" class="nav-link" type="button">Kelime Öğrenimi</button>
    </nav>

    <div class="nav-cta">
      <button id="nav-theme" class="icon-btn" type="button" title="Tema Değiştir" aria-label="Tema Değiştir">🌙</button>

      <button id="nav-known-icon" class="icon-chest" type="button" aria-label="Bilinen Kelimeler">
        <img id="nav-chest-img" src="../assets/images/off-chest.png" alt="" width="36" height="36" decoding="async" loading="lazy">
      </button>

      <div class="nav-dropdown">
        <!-- <button id="nav-level" class="nav-link nav-dd-btn" type="button" aria-haspopup="true" aria-expanded="false">
          Seviye <span id="nav-level-badge" class="nav-pill">—</span>
        </button> -->
        <div class="nav-dd" role="menu" aria-label="Seviye seç">
          <button class="nav-dd-item" data-lvl="A1" role="menuitem">A1</button>
          <button class="nav-dd-item" data-lvl="A2" role="menuitem">A2</button>
          <button class="nav-dd-item" data-lvl="B1" role="menuitem">B1</button>
          <button class="nav-dd-item" data-lvl="B2" role="menuitem">B2</button>
          <button class="nav-dd-item" data-lvl="C1" role="menuitem">C1</button>
        </div>
      </div>

      <button id="nav-burger" class="burger" type="button" aria-label="Menüyü aç/kapat" aria-expanded="false" aria-controls="nav-drawer">
        <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <div id="nav-drawer" class="nav-drawer" role="dialog" aria-modal="false" aria-label="Mobil menü">
    <button class="drawer-item" id="md-free" type="button">Serbest Gezinim</button>
    <button class="drawer-item" id="md-test" type="button">Kelime Öğrenimi</button>

    <div class="drawer-sep"></div>

    <div class="drawer-group">
      <div class="drawer-group-title">Seviye</div>
      <div class="drawer-levels">
        <button class="lvl-chip" data-lvl="A1">A1</button>
        <button class="lvl-chip" data-lvl="A2">A2</button>
        <button class="lvl-chip" data-lvl="B1">B1</button>
        <button class="lvl-chip" data-lvl="B2">B2</button>
        <button class="lvl-chip" data-lvl="C1">C1</button>
      </div>
    </div>

    <div class="drawer-actions">
      <button id="md-reselect" class="pill-btn" type="button">Seviye Seçim Ekranı</button>
      <button id="md-theme" class="icon-btn" type="button" title="Tema Değiştir">🌙</button>
    </div>
  </div>
</header>

  <!-- reselect -->
  <button id="reselectBtn" class="reselect-btn" title="Seviyeyi Değiştir" aria-label="Seviyeyi Değiştir">⟵ Seviyeyi Değiştir</button>

  <button id="drawerBtn" class="drawer-btn" aria-label="Bilinen Kelimeler">
    <img id="chestIcon" src="../assets/images/off-chest.png" alt="" class="chest-icon" loading="lazy" decoding="async">
  </button>

  <div id="drawer" class="drawer" role="dialog" aria-modal="false" aria-label="Bilinen Kelimeler">
    <div style="font-weight:800; margin-bottom:6px;">Bilinen Kelimeler</div>
    <div id="levelsWrapper" class="levels-wrapper"></div>
    <div id="knownBox" style="line-height:1.5; margin-top:8px;"></div>
  </div>

  <!-- FREE MODE -->
  <div id="free-wrap" class="wrap" style="display:none;">
    <div class="card" onclick="flipCard()" aria-label="Kelime Kartı">
      <div id="cardInner" class="card-inner">
        <div id="front" class="face front">
          <div class="card-meta">
            <span id="badgeFront" class="badge">Type</span>
            <div class="avatar">🐍</div>
          </div>
          <div class="word"><div id="frontWord">Kelime</div></div>
        </div>
        <div id="back" class="face back">
          <div class="card-meta">
            <span id="badgeBack" class="badge">Type</span>
            <div class="avatar">🐍</div>
          </div>
          <div class="word"><div id="backWord">Anlamlar</div></div>
        </div>
      </div>
    </div>
    <div class="buttons">
      <button class="btn-flip" onclick="flipCard()" aria-label="Flip">Flip</button>
      <button class="btn-pass" onclick="passCard(event)" aria-label="Pass">Pass</button>
    </div>
  </div>

  <!-- TEST MODE -->
  <div id="test-wrap" class="wrap" style="display:none;">
    <div class="panel">
      <div class="panel-head">
        <span class="panel-badge">QUIZ</span>
        <div class="panel-title">Kelime Öğrenimi</div>
      </div>

      <div class="row">
        <div class="stat">Çalışılan Kelime: <span id="totalWorked">0</span></div>
        <div class="stat">Doğru Bilinen: <span id="correctKnown">0</span></div>
        <div class="stat">Yanlış Bilinen: <span id="wrongKnown">0</span></div>
        <div class="grow"></div>
        <div class="stat" title="Doğru/Toplam">Oran: <span id="ratio">0%</span></div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="grow progress"><div id="bar" class="bar"></div></div>
      </div>

      <div class="row tools-row" style="margin-top:12px; gap:10px;">
        <button class="btn-5050" id="hint5050" aria-label="50-50 ipucu">⚡ 50/50 (∞)</button>
        <button class="btn-5050" id="clueBtn" style="display:none;" aria-label="Clue ipucu">💡 Clue (∞)</button>
        <div class="grow"></div>
      </div>

      <h2 id="qtext" style="text-align:center;margin:14px 0 6px 0;">—</h2>

      <div id="choices" class="choices" style="display:grid;"></div>

      <div id="typing" style="display:none;">
        <div class="answer-row">
          <input id="answer" class="input" placeholder="Türkçe anlamını yaz..." aria-label="Cevap kutusu"/>
        </div>
      </div>

      <div class="actions">
        <button class="btn-next" id="nextBtn" aria-label="Sonraki Soru">⏭ Next</button>
        <button class="btn-next" id="checkBtn" aria-label="Cevabı Kontrol Et">✔ Check</button>
      </div>
    </div>
  </div>

  <!-- LEVEL DETAIL MODAL -->
  <div id="levelModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="levelModalTitle">
      <div class="modal-head">
        <div id="levelModalTitle" class="modal-title">Seviye</div>
        <button class="modal-close" id="levelModalClose" aria-label="Kapat">Kapat</button>
      </div>
      <div id="levelModalBody"></div>
    </div>
  </div>

  <!-- preload chest icons -->
  <link rel="preload" as="image" href="../assets/images/open-chest.png">
  <link rel="preload" as="image" href="../assets/images/off-chest.png">

  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div class="current-level" id="currentLevelIndicator" style="display:none;">Seviye: —</div>

<script>
/* =========================================================
   PRELOAD
   ======================================================= */
(function(){ const a=new Image();a.src='../assets/images/open-chest.png'; const b=new Image();b.src='../assets/images/off-chest.png'; })();

/* =========================================================
   CONFIG
   ======================================================= */
const CONFIG = {
  swipeThreshold: 60,
  infiniteHints: true,
  hintWeightOnCorrect: 0.5,
  allowMultipleHintsPerQuestion: false,
  levelFiles: { A1:"a1.json", A2:"a2.json", B1:"b1.json", B2:"b2.json", C1:"c1.json" },
  levelPaths: ["./", "./data/", "../data/", "./assets/data/"],
  animations: { passTimeout: 450 }
};

/* =========================================================
   UTILS
   ======================================================= */
const cap = s => s ? s.charAt(0).toUpperCase()+s.slice(1) : "";
const shuffle = (arr)=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
const nonEmpty = (x)=> x!=null && String(x).trim()!=="";
const qs = (id)=> document.getElementById(id);
const joinMeanings = (w)=> (w.meanings || []).filter(nonEmpty).join(" • ");
const toTypeKey = (t)=>{ const s=(t||"").toLowerCase(); if(s.includes("verb")) return "verb"; if(s.includes("adj")) return "adjective"; if(s.includes("noun")) return "noun"; return "noun"; };
function normalize(s){
  return (s||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ı/g,'i')
    .replace(/ö/g,'o').replace(/ş/g,'s').replace(/ü/g,'u')
    .replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
}
function editDistance(a,b){
  const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
  const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=n;j++){ const tmp=dp[j];
      if(a[i-1]===b[j-1]) dp[j]=prev;
      else dp[j]=Math.min(prev+1, dp[j]+1, dp[j-1]+1);
      prev=tmp;
  }} return dp[n];
}
function matchesAnswer(ans, w){
  const a = normalize(ans); if(!a) return {ok:false, typo:false, suggestion:null};
  const pool = (w.meanings || []).filter(nonEmpty).map(r=>({orig:r.trim(), norm:normalize(r)}));
  if(a.length<=3){ const hit=pool.find(p=>p.norm===a); return {ok:!!hit, typo:false, suggestion:hit?hit.orig:null}; }
  let best={ok:false,typo:false,suggestion:null,dist:Infinity};
  for(const p of pool){ const t=p.norm; if(Math.abs(a.length-t.length)>3) continue;
    const d=editDistance(a,t); const max=t.length<=5?1:t.length<=8?2:t.length<=12?2:3;
    if(d<=max && d<best.dist) best={ok:true,typo:d>0,suggestion:p.orig,dist:d};
  }
  return best.ok?best:{ok:false,typo:false,suggestion:null};
}

// === GENEL ORAN ===
function computeGeneralAccPct(){
  const total = words.length || 0;
  if (!total) return 0;
  let sum = 0;
  for (const w of words){
    if (w && w.tries > 0){
      sum += Math.max(0, Math.min(1, (w.correct || 0) / w.tries));
    }
  }
  return (sum / total) * 100;
}

/* =========================================================
   THEMES
   ======================================================= */
const themes = {
  noun:["linear-gradient(135deg,#60a5fa,#3b82f6)","linear-gradient(135deg,#3b82f6,#60a5fa)","var(--noun)"],
  verb:["linear-gradient(135deg,#f87171,#ef4444)","linear-gradient(135deg,#ef4444,#f87171)","var(--verb)"],
  adjective:["linear-gradient(135deg,#a78bfa,#8b5cf6)","linear-gradient(135deg,#8b5cf6,#a78bfa)","var(--adj)"],
};
const LEVEL_STYLES = {
  A1: {solid: 'var(--A1-solid)'}, A2: {solid: 'var(--A2-solid)'}, B1: {solid: 'var(--B1-solid)'},
  B2: {solid: 'var(--B2-solid)'}, C1: {solid: 'var(--C1-solid)'},
};

/* =========================================================
   SOUND
   ======================================================= */
const Sound = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let unlocked = false;
  function unlock(){ if(unlocked) return; if(ctx.state==='suspended') ctx.resume();
    const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.01); unlocked=true; }
  function tone({freq=440, dur=0.12, type='sine', vol=0.15, attack=0.005, release=0.08, startFreq}){
    const now=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain(); o.type=type;
    if(startFreq){ o.frequency.setValueAtTime(startFreq, now); o.frequency.exponentialRampToValueAtTime(freq, now+dur); }
    else o.frequency.setValueAtTime(freq, now);
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(vol, now+attack);
    g.gain.exponentialRampToValueAtTime(0.0001, now+Math.max(attack, dur-release));
    o.connect(g).connect(ctx.destination); o.start(now); o.stop(now+dur+0.05);
  }
  function trink(){ tone({freq:1200,dur:0.10,type:'sine',vol:0.18}); setTimeout(()=>tone({freq:1600,dur:0.10,type:'sine',vol:0.16}),60); }
  function dat(){ tone({freq:180,dur:0.18,type:'square',vol:0.12}); }
  function flip(){ tone({startFreq:2200,freq:900,dur:0.08,type:'triangle',vol:0.12}); }
  function pass(){ tone({startFreq:600,freq:300,dur:0.10,type:'sawtooth',vol:0.10}); }
  ['click','touchstart','pointerdown','keydown'].forEach(ev=>window.addEventListener(ev, unlock, {once:true,passive:true}));
  return { trink, dat, flip, pass };
})();

/* =========================================================
   STATE & DOM REFS
   ======================================================= */
let words = []; let freeQueue = []; let testQueue = []; let idToIdx = new Map(); let selectedLevel = null;
const LEVELS = ["A1","A2","B1","B2","C1"];
const globalStats = {}; LEVELS.forEach(l=> globalStats[l] = {tries:0, correct:0, seen:0, words:new Map()});

const tabFree=qs('tab-free'), tabTest=qs('tab-test'), freeWrap=qs('free-wrap'), testWrap=qs('test-wrap'), tabsEl=qs('tabs'), indicator=qs('tabIndicator');
const inner = qs("cardInner"); const fWordDiv = qs("frontWord"); const bWordDiv = qs("backWord"); const fBadge=qs("badgeFront"); const bBadge=qs("badgeBack");
const drawerBtn=qs('drawerBtn'), drawer=qs('drawer'), chestIcon=qs('chestIcon'), levelsWrapper=qs('levelsWrapper');

const totalWorkedEl=qs('totalWorked'), correctKnownEl=qs('correctKnown'), wrongKnownEl=qs('wrongKnown'), barEl=qs('bar'), ratioEl=qs('ratio');
const knownEl=qs('knownBox'), qtextEl=qs('qtext'), choicesEl=qs('choices'), typingEl=qs('typing'), answerEl=qs('answer');
const checkBtn=qs('checkBtn'), nextBtn=qs('nextBtn'), hintBtn=qs('hint5050'), clueBtn=qs('clueBtn');

let triesTotal=0, correctTotal=0;
let testMode='mc'; let currentQ=null; let answered=false; let lock=false; let removedIdx=[];
let usedHintThisQuestion=false;
let isPassing=false; let suppressClick=false;

const levelSelectEl=qs('levelSelect'), levelGridEl=qs('levelGrid'), reselectBtn=qs('reselectBtn');
const discoveredUrl = {};

/* =========================================================
   TOAST
   ======================================================= */
function showToast(message, variant='warning', timeout=2200){
  const cont = qs('toastContainer'); if(!cont) return;
  const el = document.createElement('div');
  el.className = `toast ${variant}`;
  el.innerHTML = `<div class="row"><div>${message}</div><button class="close" aria-label="Kapat">×</button></div>`;
  cont.appendChild(el);
  const remove = ()=>{ el.style.animation = 'toastOut .22s ease forwards'; setTimeout(()=> el.remove(), 220); };
  el.querySelector('.close')?.addEventListener('click', remove);
  if (timeout > 0) setTimeout(remove, timeout);
}

/* =========================================================
   DATA LOADER
   ======================================================= */
async function tryFetch(url){
  try{ const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text();}
  catch(e){ return null; }
}
function parseFlexibleJson(text){
  const trimmed = (text||"").trim();
  if(trimmed.startsWith('[')){
    try{ const arr = JSON.parse(trimmed); return Array.isArray(arr) ? arr : []; }catch{}
  }
  const lines = trimmed.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(let line of lines){
    if(line.endsWith(',')) line = line.slice(0,-1);
    try{ out.push(JSON.parse(line)); }catch{}
  }
  return out;
}
function normalizeWordShape(list){
  return list.map((w,i)=>({
    id: i+1,
    en: w.en,
    meanings: Array.isArray(w.meanings) ? w.meanings.filter(nonEmpty) : (nonEmpty(w.meanings) ? [String(w.meanings)] : []),
    type: (w.type||"").toLowerCase(),
    level: (w.level||selectedLevel||"").toUpperCase(),
    tries: 0, correct: 0
  }));
}
async function loadLevelFile(level){
  if(discoveredUrl[level]){
    const t = await tryFetch(discoveredUrl[level]);
    if(t) return parseFlexibleJson(t);
  }
  const fname = CONFIG.levelFiles[level];
  for(const base of CONFIG.levelPaths){
    const url = base + fname;
    const text = await tryFetch(url);
    if(text){ discoveredUrl[level] = url; return parseFlexibleJson(text); }
  }
  return null;
}
async function countLevelWords(level){
  const arr = await loadLevelFile(level);
  return Array.isArray(arr) ? arr.length : 0;
}

/* =========================================================
   LEVEL SELECT
   ======================================================= */
function renderLevelCards(counts){
  levelGridEl.innerHTML = "";
  LEVELS.forEach(lvl=>{
    const card = document.createElement('div');
    card.className = `level-card ${lvl}`; card.setAttribute('role','listitem'); card.dataset.level = lvl;
    card.innerHTML = `<div class="level-name">${lvl}</div><div class="level-count" id="cnt-${lvl}">${counts[lvl] ?? '—'} kelime</div>`;
    card.onclick = ()=> pickLevel(lvl, card);
    levelGridEl.appendChild(card);
  });
}
async function buildLevelSelect(){
  const counts = {};
  await Promise.all(LEVELS.map(async lvl=>{
    try{ counts[lvl] = await countLevelWords(lvl); } catch{ counts[lvl] = 0; }
  }));
  renderLevelCards(counts);
}
function revealMainUI(){
  tabsEl.style.display = 'flex';
  tabFree.classList.add('active'); tabTest.classList.remove('active');
  freeWrap.style.display='flex'; testWrap.style.display='none';
  drawerBtn.style.display = 'inline-flex';
  moveIndicator(tabFree);
  reselectBtn.style.display = 'inline-flex';
  updateReselectResponsive();
  // Yeni: yükseklik ölç, çakışma olmasın
  updateHeights();
  window.scrollTo({top:0, behavior:'smooth'});
}
function updateReselectResponsive(){
  if(reselectBtn.style.display !== 'none'){
    if(window.innerWidth<=600) document.body.classList.add('has-reselect');
    else document.body.classList.remove('has-reselect');
  }else{
    document.body.classList.remove('has-reselect');
  }
}
window.addEventListener('resize', ()=>{ updateReselectResponsive(); updateHeights(); });

async function pickLevel(level){
  if(!level) return;
  selectedLevel = level;
  const raw = await loadLevelFile(level);
  if(!raw || !raw.length){ showToast(`${level} verisi bulunamadı. Dosya yolunu kontrol et.`, 'error', 3000); return; }

  words = normalizeWordShape(raw);
  idToIdx = new Map(words.map((w,idx)=>[w.id, idx]));
  freeQueue = shuffle(words.map(w=>w.id));
  testQueue = shuffle(words.map(w=>w.id));
  triesTotal = 0; correctTotal = 0;

  const cards = [...levelGridEl.children];
  cards.forEach((el, idx) => { setTimeout(()=> el.classList.add('fade-away'), idx*40); });
  const titleEl = document.querySelector('#levelSelect .level-badge');
  if (titleEl){
    titleEl.style.willChange = 'opacity, transform, filter';
    titleEl.style.transition = 'opacity .42s ease, transform .42s ease, filter .42s ease';
    requestAnimationFrame(()=>{
      titleEl.style.opacity = '0';
      titleEl.style.transform = 'translateY(6px) scale(.98)';
      titleEl.style.filter = 'blur(2px)';
    });
  }
  const totalFade = 420 + cards.length*40;

  setTimeout(()=>{
    document.body.classList.remove('stage-select');
    levelSelectEl.style.display = 'none';
    revealMainUI();
    buildLevelRings();
    renderCard();
    renderQuestion();
    updateLevelRings();
    setLevelIndicator(true, level);
  }, totalFade);
}

/* back to level selection */
reselectBtn.onclick = async ()=>{
  tabsEl.style.display = 'none';
  freeWrap.style.display = 'none';
  testWrap.style.display = 'none';
  drawerBtn.style.display = 'none';
  reselectBtn.style.display = 'none';
  updateReselectResponsive();
  await buildLevelSelect();
  document.body.classList.add('stage-select');
  levelSelectEl.style.display = 'flex';
  const titleEl = document.querySelector('#levelSelect .level-badge');
  if (titleEl){
    titleEl.style.transition = ''; titleEl.style.willChange = '';
    titleEl.style.opacity = '1'; titleEl.style.transform = 'none'; titleEl.style.filter = 'none';
  }
  setLevelIndicator(false);
  selectedLevel = null;
  window.scrollTo({top:0, behavior:'smooth'});
  updateCurrentLevelIndicator(null);
  const ind = qs("currentLevelIndicator"); if (ind) ind.style.display = "none";
};

/* =========================================================
   TABS & THEME
   ======================================================= */
function moveIndicator(target){
  if(!target || !tabsEl) return;
  const tabsRect = tabsEl.getBoundingClientRect();
  const tRect = target.getBoundingClientRect();
  indicator.style.left = (tRect.left - tabsRect.left) + 'px';
  indicator.style.top  = (tRect.top  - tabsRect.top ) + 'px';
  indicator.style.width  = tRect.width + 'px';
  indicator.style.height = tRect.height + 'px';
  indicator.style.borderRadius = '12px';
  // Yükseklik değişmiş olabilir
  updateHeights();
}
window.addEventListener('resize', ()=> moveIndicator(document.querySelector('.tab.active')));

tabFree.onclick = ()=>{ tabFree.classList.add('active'); tabTest.classList.remove('active'); freeWrap.style.display='flex'; testWrap.style.display='none'; moveIndicator(tabFree); window.scrollTo({top:0, behavior:'smooth'}); };
tabTest.onclick = ()=>{ tabTest.classList.add('active'); tabFree.classList.remove('active'); freeWrap.style.display='none'; testWrap.style.display='flex'; moveIndicator(tabTest); window.scrollTo({top:0, behavior:'smooth'}); };

const themeToggle = qs('themeToggle');
themeToggle.onclick = ()=>{
  const body=document.body; const isLight=(body.getAttribute('data-theme')!=='dark');
  body.setAttribute('data-theme', isLight ? 'dark' : 'light');
  themeToggle.textContent = isLight ? '☀️' : '🌙';
  updateHeights();
};

/* =========================================================
   DRAWER & MODAL
   ======================================================= */
let lastFocusEl = null;
drawerBtn.onclick = () => {
  const isHidden = (drawer.style.display==='none' || drawer.style.display==='');
  drawer.style.display = isHidden ? 'block' : 'none';
  if (chestIcon) chestIcon.src = isHidden ? '../assets/images/open-chest.png' : '../assets/images/off-chest.png';
  if (isHidden){ lastFocusEl = document.activeElement; drawer.setAttribute('tabindex','-1'); drawer.focus(); }
  else{ drawer.removeAttribute('tabindex'); lastFocusEl?.focus?.(); }
};

function openLevelDetail(level){
  const gs = globalStats[level] || {words:new Map()};
  const arr = [...gs.words.values()].sort((a,b)=> (b.tries||0) - (a.tries||0) || a.en.localeCompare(b.en));
  qs('levelModalTitle').textContent = `${level} • Kelime Geçmişi`;
  const rows = arr.map(w=>{
    const wrong = Math.max(0,(w.tries||0) - (w.correct||0));
    return `<tr><td><span class="pill">${(w.level||'-')}</span></td><td><strong>${w.en}</strong></td><td>${(w.meanings||[]).filter(nonEmpty).join(" • ") || "—"}</td><td>${w.tries||0}</td><td>${(w.correct||0).toFixed(1)}</td><td>${wrong.toFixed(1)}</td></tr>`;
  }).join("");
  qs('levelModalBody').innerHTML =
    `<table class="words-table"><thead><tr><th>Seviye</th><th>Kelime (EN)</th><th>Anlamlar</th><th>Çıkma</th><th>Doğru(Puan)</th><th>Yanlış</th></tr></thead><tbody>${rows || `<tr><td colspan="6">Bu seviyede henüz veri yok.</td></tr>`}</tbody></table>`;
  const bd = qs('levelModalBackdrop');
  bd.style.display = 'flex'; bd.setAttribute('aria-hidden','false');
  lastFocusEl = document.activeElement; qs('levelModalClose').focus();
}
function closeLevelDetail(){
  const bd = qs('levelModalBackdrop');
  bd.style.display = 'none'; bd.setAttribute('aria-hidden','true');
  qs('levelModalClose').blur(); lastFocusEl?.focus?.();
}
qs('levelModalClose').addEventListener('click', closeLevelDetail);
qs('levelModalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='levelModalBackdrop') closeLevelDetail(); });

/* =========================================================
   LEVEL RINGS (GLOBAL STATS)
   ======================================================= */
function buildLevelRings(){
  levelsWrapper.innerHTML = "";
  LEVELS.forEach(lvl=>{
    const item = document.createElement('div'); item.className = 'level-item'; item.dataset.level = lvl; item.setAttribute('tabindex','0'); item.setAttribute('role','button'); item.setAttribute('aria-label',`${lvl} seviyesini aç`);
    const ring = document.createElement('div'); ring.className = 'level-ring'; ring.id = `ring-${lvl}`;
    const ringTxt = document.createElement('span'); ringTxt.className = 'ring-text'; ringTxt.textContent = lvl; ring.appendChild(ringTxt);
    const meta = document.createElement('div'); meta.className = 'level-meta';
    meta.innerHTML = `<div class="level-acc">Doğru: <span id="acc-${lvl}">0/0</span></div><div class="level-seen">Görülen kelime: <span id="seen-${lvl}">0</span></div>`;
    item.appendChild(ring); item.appendChild(meta);
    item.addEventListener('click', ()=> openLevelDetail(lvl));
    item.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') openLevelDetail(lvl); });
    levelsWrapper.appendChild(item);
  });
  updateLevelRings();
}
function updateLevelRings(){
  LEVELS.forEach(lvl=>{
    const gs = globalStats[lvl] || {tries:0,correct:0,seen:0};
    const acc = qs(`acc-${lvl}`); const seen=qs(`seen-${lvl}`); const ring=qs(`ring-${lvl}`);
    const total = gs.tries || 0, ok = gs.correct || 0, pct = total ? (ok/total)*100 : 0;
    acc && (acc.textContent = `${ok.toFixed(1)}/${total}`);
    seen && (seen.textContent = gs.seen || 0);
    if(ring){ const deg = (pct/100)*360; ring.style.setProperty('--deg', `${deg}deg`); }
  });
}

/* =========================================================
   FREE MODE
   ======================================================= */
function paintCard(w){
  const key = toTypeKey(w.type);
  const [g1,g2] = themes[key];
  const lvl = (w.level || selectedLevel || 'A1').toUpperCase();
  const lvlStyle = LEVEL_STYLES[lvl] || LEVEL_STYLES.A1;
  qs("front").style.backgroundImage = g1; qs("back").style.backgroundImage  = g2;
  const solidVar = lvlStyle.solid.replace('var(','').replace(')','').trim();
  const solidColor = getComputedStyle(document.documentElement).getPropertyValue(solidVar) || '#22c55e';
  qs("cardInner").style.boxShadow = `0 18px 40px rgba(0,0,0,.25), 0 0 0 3px ${solidColor.trim()}55 inset`;
  fBadge.textContent = `${cap(key)} • ${w.level || (selectedLevel || '-')}`;
  bBadge.textContent = `${cap(key)} • ${w.level || (selectedLevel || '-')}`;
  qs("cardInner").setAttribute("data-type", key);
}
function currentFreeId(){ return freeQueue.length ? freeQueue[0] : 1; }
function currentFreeWord(){ const id=currentFreeId(); return words[idToIdx.get(id)]; }
function renderCard(){
  const w = currentFreeWord(); if(!w) return;
  fWordDiv.textContent = w.en;
  bWordDiv.textContent = joinMeanings(w) || "—";
  paintCard(w);
  const c = qs("cardInner");
  c.classList.remove("flipped","enter-right");
  void c.offsetWidth;
  c.classList.add("enter-right");
  c.addEventListener("animationend", () => c.classList.remove("enter-right"), { once:true });
}
      function flipCard(){
        if (suppressClick || isPassing) { suppressClick = false; return; }
        const c = qs("cardInner");
        c.classList.add('animating'); Sound.flip(); c.classList.toggle('flipped');
        const onEnd = (e)=>{ if(e.propertyName!=='transform') return; c.classList.remove('animating'); c.removeEventListener('transitionend', onEnd); };
        c.addEventListener('transitionend', onEnd);
      }
      function passCard(e){
        if (e) e.stopPropagation();
        if (isPassing) return;
        isPassing = true; Sound.pass();
        const id = freeQueue.shift(); freeQueue.push(id);
        const c = qs("cardInner");
        c.classList.add('animating'); c.classList.remove('enter-right'); c.classList.add('pass-left');
        const finish = () => { c.classList.remove('pass-left'); renderCard(); requestAnimationFrame(()=> c.classList.remove('animating')); isPassing = false; };
        let done = false;
        const onEnd = () => { if (done) return; done = true; c.removeEventListener('animationend', onEnd); finish(); };
        c.addEventListener('animationend', onEnd);
        setTimeout(onEnd, CONFIG.animations.passTimeout);
      }
      (function addSwipe(){
        const card = document.querySelector('.card');
        let startX = 0, dx = 0, dragging = false;
        const THRESH = CONFIG.swipeThreshold;
        const onDown = (e)=>{ dragging = true; startX = (e.touches ? e.touches[0].clientX : e.clientX); dx = 0; };
        const onMove = (e)=>{ if(!dragging) return; const x=(e.touches?e.touches[0].clientX:e.clientX); dx = x - startX; };
        const onUp = ()=>{ if(!dragging) return; dragging=false; if (dx <= -THRESH){ suppressClick = true; passCard(); } else if (dx >= THRESH){ suppressClick = true; flipCard(); } dx = 0; };
        card.addEventListener('pointerdown', onDown, {passive:true});
        card.addEventListener('pointermove', onMove, {passive:true});
        card.addEventListener('pointerup', onUp);
        card.addEventListener('pointercancel', onUp);
        card.addEventListener('touchstart', onDown, {passive:true});
        card.addEventListener('touchmove', onMove, {passive:true});
        card.addEventListener('touchend', onUp);
      })();

      /* =========================================================
         TEST MODE
         ======================================================= */
      function feedback(ok){
        const panel = document.querySelector('.panel'); if(!panel) return;
        panel.classList.remove('flash-correct','shake-wrong');
        panel.classList.add(ok ? 'flash-correct' : 'shake-wrong');
        setTimeout(()=> panel.classList.remove('flash-correct','shake-wrong'), ok ? 650 : 500);
      }
      function updateStatsBar(){
        totalWorkedEl.textContent = triesTotal;
        correctKnownEl.textContent = correctTotal.toFixed(1);
        wrongKnownEl.textContent = Math.max(0, triesTotal - Math.round(correctTotal)).toString();

        const r = Math.round(computeGeneralAccPct());
        ratioEl.textContent = r+"%";
        barEl.style.width = r+"%";

        const known = words.filter(w=> w.tries>=3 && (w.correct/w.tries)>=1.0 );
        knownEl.textContent = known.map(w=> `${w.en} (${joinMeanings(w)})`).join(", ") || "—";
        updateLevelRings();
      }
      function currentTestId(){ return testQueue.length ? testQueue[0] : 1; }
      function currentTestWord(){ const id=currentTestId(); return words[idToIdx.get(id)]; }

      function makeMCQuestion(w){
        const correct = (w.meanings && w.meanings[0]) || "";
        const othersPool = words.filter(x=>x.id!==w.id).flatMap(x=> x.meanings || []).filter(nonEmpty);
        shuffle(othersPool);
        const opts = [correct];
        for(const o of othersPool){ if(opts.length>=4) break; if(!opts.includes(o)) opts.push(o); }
        shuffle(opts);
        return { word:w, ask:'foreign', answer:correct, options:opts, type:'mc' };
      }
      function makeTypingQuestion(w){
        const answers = (w.meanings || []).filter(nonEmpty);
        return { word:w, ask:'foreign', answerSet:answers, answer:answers[0] || "", type:'typing' };
      }

      function toggleHints(){
        const label = CONFIG.infiniteHints ? '∞' : '';
        if(testMode==='mc'){ hintBtn.style.display='inline-block'; clueBtn.style.display='none'; checkBtn.style.display='none'; answerEl.blur(); }
        else{ hintBtn.style.display='none'; clueBtn.style.display='inline-block'; checkBtn.style.display='inline-block'; }
        hintBtn.textContent = `⚡ 50/50 (${label})`; clueBtn.textContent = `💡 Clue (${label})`;

        const disable = usedHintThisQuestion;
        [hintBtn, clueBtn].forEach(btn=>{
          btn.disabled = disable;
          btn.style.filter = disable ? "grayscale(1)" : "";
          btn.style.cursor  = disable ? "not-allowed" : "pointer";
          btn.setAttribute('aria-disabled', String(disable));
        });
      }

      function renderQuestion(){
        if(!testQueue.length) return;
        answered = false; lock=false; removedIdx=[]; usedHintThisQuestion = false;
        checkBtn.textContent = "✔ Check"; checkBtn.style.filter = ""; checkBtn.disabled = false;

        const w = currentTestWord();

        const genAcc = computeGeneralAccPct();
        const pMcWhenLow  = 0.60;
        const pMcWhenHigh = 0.40;
        const pMC = (genAcc < 60) ? pMcWhenLow : pMcWhenHigh;
        testMode = (Math.random() < pMC) ? 'mc' : 'typing';

        if(testMode==='mc'){
          currentQ = makeMCQuestion(w);
          qtextEl.textContent = `To Turkish  ➜  ${w.en}`;
          choicesEl.style.display='grid';
          typingEl.style.display='none';
          choicesEl.innerHTML="";
          currentQ.options.forEach((opt,i)=>{
            const div = document.createElement('div');
            div.className='choice'; div.textContent=opt; div.onclick = ()=> choose(i);
            choicesEl.appendChild(div);
          });
        }else{
          currentQ = makeTypingQuestion(w);
          qtextEl.textContent = `To Turkish  ➜  ${w.en}`;
          choicesEl.style.display='none';
          typingEl.style.display='block';
          answerEl.value=""; answerEl.focus();
        }

        toggleHints();
        updateStatsBar();
      }

      function finalize(ok){
        answered = true; lock = true;
        const w = currentTestWord();
        const idx = idToIdx.get(w.id);

        const gain = ok ? (usedHintThisQuestion ? CONFIG.hintWeightOnCorrect : 1.0) : 0.0;

        words[idx].tries++; triesTotal++;
        if(ok){ words[idx].correct = (w.correct || 0) + gain; correctTotal += gain; }

        const L = (w.level || selectedLevel || '').toUpperCase();
        if(LEVELS.includes(L)){
          const gs = globalStats[L];
          const key = (w.en||'').toLowerCase();
          let entry = gs.words.get(key);
          if(!entry){
            entry = { en: w.en, meanings: (w.meanings||[]).slice(), level: L, tries: 0, correct: 0 };
            gs.words.set(key, entry);
            gs.seen += 1;
          }
          entry.tries += 1; gs.tries += 1;
          if(ok){ entry.correct += gain; gs.correct += gain; }
        }

        const id = testQueue.shift();
        if(ok){ testQueue.push(id); }
        else{ const pos = Math.min(3, testQueue.length); testQueue.splice(pos, 0, id); }

        updateLevelRings();
        updateStatsBar();
      }

      function choose(i){
        if(lock) return;
        const nodes = [...choicesEl.children];
        nodes.forEach(n => n.classList.remove('fx-correct','fx-wrong'));
        const correctIdx = currentQ.options.findIndex(x=>x===currentQ.answer);
        const ok = (i===correctIdx);
        if(ok){ nodes[i].classList.add('correct','fx-correct'); Sound.trink(); }
        else{ nodes[i].classList.add('wrong','fx-wrong'); nodes[correctIdx]?.classList.add('correct','fx-correct'); Sound.dat(); }
        feedback(ok); finalize(ok);
        setTimeout(()=> nodes.forEach(n => n.classList.remove('fx-correct','fx-wrong')), 700);
      }

      /* Hints */
      hintBtn.onclick = ()=>{
        if(testMode!=='mc' || lock || usedHintThisQuestion) return;
        const nodes = [...choicesEl.children];
        const correctIdx = currentQ.options.findIndex(x=>x===currentQ.answer);
        const wrongs = nodes.map((n,idx)=>idx).filter(k=>k!==correctIdx && !removedIdx.includes(k));
        let hidden=0; while(hidden<2 && wrongs.length){
          const pick = wrongs.splice(Math.floor(Math.random()*(wrongs.length)),1)[0];
          nodes[pick].style.visibility='hidden';
          removedIdx.push(pick); hidden++;
        }
        usedHintThisQuestion = true; toggleHints();
      };

      clueBtn.onclick = ()=>{
        if(testMode!=='typing' || lock || usedHintThisQuestion) return;
        const set = currentQ.answerSet || [];
        const theTruth = (set[0]||"").trim(); if(!theTruth) return;
        const revealLen = theTruth.length <= 4 ? 2 : 3;
        answerEl.value = theTruth.slice(0, revealLen);
        answerEl.focus(); answerEl.setSelectionRange(answerEl.value.length, answerEl.value.length);
        usedHintThisQuestion = true; toggleHints();
      };

      function checkTyping(){
        if (lock || testMode!=='typing') return;
        const ans = answerEl.value.trim();
        if (ans === ""){
          checkBtn.textContent = "Önce bir cevap yaz 🙂"; answerEl.focus();
          const prevBorder = answerEl.style.borderColor; answerEl.style.borderColor = "#ef4444";
          setTimeout(() => { checkBtn.textContent = "✔ Check"; answerEl.style.borderColor = prevBorder || ""; }, 900);
          return;
        }

        const w = currentTestWord();
        const { ok, typo, suggestion } = matchesAnswer(ans, w);

        answerEl.classList.remove('fx-correct','fx-wrong');
        if (ok){
          answerEl.classList.add('fx-correct'); Sound.trink(); feedback(true);
          if (typo && suggestion){ showToast(`✔ Doğru, ama ufak yazım hatası: “${ans}” → “${suggestion}”`, 'warning', 2600); }
          checkBtn.textContent = typo ? "✔ Doğru (ufak yazım hatası)" : "✔ Doğru!";
          checkBtn.style.filter = "saturate(1.15)";
        } else {
          answerEl.classList.add('fx-wrong'); Sound.dat(); feedback(false);
          checkBtn.textContent = `Cevap(lar): ${joinMeanings(w)}`;
          checkBtn.style.filter = "saturate(0.9)";
        }

        setTimeout(()=> answerEl.classList.remove('fx-correct','fx-wrong'), ok ? 650 : 500);
        finalize(ok);
      }
      checkBtn && (checkBtn.onclick = checkTyping);
      answerEl && answerEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkTyping(); });

      nextBtn && (nextBtn.onclick = ()=>{
        if (!answered) { nextBtn.textContent = "Önce cevap ver!"; setTimeout(() => { nextBtn.textContent = "⏭ Next"; }, 900); return; }
        renderQuestion();
      });

      /* =========================================================
         KEYBOARD SHORTCUTS & A11Y
         ======================================================= */
      document.addEventListener('keydown', (e)=>{
        const inInput = ['INPUT','TEXTAREA'].includes(document.activeElement?.tagName);
        if(inInput) return;
        if(e.key===' ' || e.key==='Enter'){ e.preventDefault(); flipCard(); }
        else if(e.key==='ArrowLeft'){ e.preventDefault(); passCard(); }
        else if(e.key==='ArrowRight'){ e.preventDefault(); if(answered) renderQuestion(); }
        else if(e.key==='Escape'){
          const modalOpen = qs('levelModalBackdrop').style.display==='flex';
          if(modalOpen) return closeLevelDetail();
          if(drawer && drawer.style.display==='block'){ drawerBtn.click(); }
        }
      });

      /* =========================================================
         GLOBALS
         ======================================================= */
      window.flipCard = flipCard;
      window.passCard = passCard;

      /* =========================================================
         INIT
         ======================================================= */
      function setLevelIndicator(visible, levelText){
        const el = qs("currentLevelIndicator"); if(!el) return;
        el.style.display = visible ? "inline-block" : "none";
        if (typeof levelText !== 'undefined') { el.textContent = levelText ? `Seviye: ${levelText}` : "Seviye: —"; }
      }
      function updateCurrentLevelIndicator(level){ setLevelIndicator(!!level, level); }

      // Navbar yüksekliği & tabs yüksekliği ölçümü (çakışmayı önlemek için)
      function updateHeights(){
        const nav = document.querySelector('.navbar');
        const tabs = document.getElementById('tabs');
        const navH = nav ? Math.ceil(nav.getBoundingClientRect().height) : 68;
        const tabsH = tabs && getComputedStyle(tabs).display!=='none'
          ? Math.ceil(tabs.getBoundingClientRect().height)
          : 56;
        document.documentElement.style.setProperty('--navH', navH + 'px');
        document.documentElement.style.setProperty('--tabsH', tabsH + 'px');
      }

      window.addEventListener('load', async ()=>{
        setLevelIndicator(false);
        await buildLevelSelect();
        updateHeights();
      });

      /* ===== NAVBAR JS BİNDINGS ===== */
      (function(){
        const $ = (id)=>document.getElementById(id);
        const navFree = $("nav-free"), navTest=$("nav-test");
        const mdFree=$("md-free"), mdTest=$("md-test");
        const navTheme=$("nav-theme"), mdTheme=$("md-theme");
        const mdResel=$("md-reselect");
        const burger=$("nav-burger"), drawer=$("nav-drawer");
        const levelBtn=$("nav-level"), levelBadge=$("nav-level-badge");
        const dd = document.querySelector(".nav-dd");

        function setActive(which){
          [navFree, navTest].forEach(btn=>btn && btn.classList.remove("active"));
          if(which==="free") navFree?.classList.add("active");
          if(which==="test") navTest?.classList.add("active");
        }

        function showFree(){
          const el = document.getElementById("tab-free");
          if(el){ el.click(); setActive("free"); window.scrollTo({top:0,behavior:"smooth"}); }
        }
        function showTest(){
          const el = document.getElementById("tab-test");
          if(el){ el.click(); setActive("test"); window.scrollTo({top:0,behavior:"smooth"}); }
        }

        function toggleTheme(){
          const t = document.getElementById("themeToggle");
          if(t){ t.click(); }
          const isDark = document.body.getAttribute("data-theme")==="dark";
          if(navTheme) navTheme.textContent = isDark ? "☀️" : "🌙";
          if(mdTheme)  mdTheme.textContent  = isDark ? "☀️" : "🌙";
        }

        function doReselect(){
          const b = document.getElementById("reselectBtn");
          if(b){ b.click(); closeDrawer(); }
        }

        function openDrawer(){ if(!drawer) return; drawer.style.display="block"; burger.setAttribute("aria-expanded","true"); }
        function closeDrawer(){ if(!drawer) return; drawer.style.display="none"; burger.setAttribute("aria-expanded","false"); }
        burger && burger.addEventListener("click", ()=>{ const isOpen = drawer && drawer.style.display==="block"; isOpen?closeDrawer():openDrawer(); });

        navFree?.addEventListener("click", showFree);
        navTest?.addEventListener("click", showTest);
        mdFree?.addEventListener("click", ()=>{ showFree(); closeDrawer(); });
        mdTest?.addEventListener("click", ()=>{ showTest(); closeDrawer(); });

        navTheme?.addEventListener("click", toggleTheme);
        mdTheme?.addEventListener("click", ()=>{ toggleTheme(); closeDrawer(); });

        mdResel?.addEventListener("click", doReselect);

        function closeDD(){ if(dd){ dd.style.display="none"; levelBtn?.setAttribute("aria-expanded","false"); } }
        function openDD(){ if(dd){ dd.style.display="block"; levelBtn?.setAttribute("aria-expanded","true"); } }
        levelBtn?.addEventListener("click", (e)=>{
          e.stopPropagation();
          const open = dd && dd.style.display==="block";
          open ? closeDD() : openDD();
        });
        document.addEventListener("click", (e)=>{ if(dd && dd.style.display==="block" && !dd.contains(e.target)) closeDD(); });
        document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") { closeDD(); closeDrawer(); } });

        function goLevel(lvl){
          if(typeof pickLevel === "function"){ pickLevel(lvl); }
          closeDD(); closeDrawer();
        }
        document.querySelectorAll(".nav-dd-item").forEach(btn=>{
          btn.addEventListener("click", ()=> goLevel(btn.dataset.lvl));
        });
        document.querySelectorAll(".lvl-chip").forEach(btn=>{
          btn.addEventListener("click", ()=> goLevel(btn.dataset.lvl));
        });

        function syncLevelBadge(){
          const ind = document.getElementById("currentLevelIndicator");
          const text = ind && ind.textContent ? ind.textContent.replace("Seviye:","").trim() : "—";
          if(levelBadge) levelBadge.textContent = text || "—";
        }

        const tabFreeBtn = document.getElementById("tab-free");
        const tabTestBtn = document.getElementById("tab-test");
        tabFreeBtn?.addEventListener("click", ()=> setActive("free"));
        tabTestBtn?.addEventListener("click", ()=> setActive("test"));

        window.addEventListener("load", ()=>{
          const isDark = document.body.getAttribute("data-theme")==="dark";
          if(navTheme) navTheme.textContent = isDark ? "☀️" : "🌙";
          if(mdTheme)  mdTheme.textContent  = isDark ? "☀️" : "🌙";
          setActive("free");
          syncLevelBadge();
          const observer = new MutationObserver(syncLevelBadge);
          const ind = document.getElementById("currentLevelIndicator");
          if(ind) observer.observe(ind, {childList:true, subtree:true, characterData:true});
        });
      })();

      // Bilinen kelimeler sandığı ikon senkronu
      const navKnownIcon = document.getElementById("nav-known-icon");
      const navChestImg  = document.getElementById("nav-chest-img");
      function toggleKnownDrawer(){
        const btn = document.getElementById("drawerBtn");
        const drawer = document.getElementById("drawer");
        if(!btn || !drawer) return;
        const willOpen = (drawer.style.display==='none' || drawer.style.display==='');
        btn.click();
        if(navChestImg){
          navChestImg.src = willOpen ? "../assets/images/open-chest.png"
                                     : "../assets/images/off-chest.png";
        }
      }
      navKnownIcon?.addEventListener("click", toggleKnownDrawer);
      document.addEventListener("click", (e)=>{
        const drawer = document.getElementById("drawer");
        if(!drawer || !navChestImg) return;
        if(drawer.style.display==='block') return;
        navChestImg.src = "../assets/images/off-chest.png";
      });
      document.addEventListener("keydown", (e)=>{
        if(e.key!=="Escape") return;
        const drawer = document.getElementById("drawer");
        if(!drawer || !navChestImg) return;
        setTimeout(()=>{
          if(drawer.style.display!=='block'){
            navChestImg.src = "../assets/images/off-chest.png";
          }
        }, 0);
      });
    </script>
  </body>
</html>
